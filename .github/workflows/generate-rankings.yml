name: Generate Pondered Rankings

on:
  # Exécuter automatiquement toutes les 24 heures
  schedule:
    - cron: '0 */24 * * *'
  
  # Permet aussi de déclencher manuellement
  workflow_dispatch:

# Permissions nécessaires pour pousser des modifications
permissions:
  contents: write

jobs:
  generate-rankings:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: List files in repository
        run: ls -la
      
      - name: Create data directory if it doesn't exist
        run: mkdir -p data
      
      - name: Modify script to ensure it works in GitHub Actions
        run: |
          sed -i 's|const OUTPUT_DIR = \x27\./data\x27;|const OUTPUT_DIR = \x27data\x27;|g' extract-pondered-rankings.js
      
      - name: Generate rankings with debug output
        run: |
          echo "===== SCRIPT CONTENT ====="
          cat extract-pondered-rankings.js
          echo "=========================="
          node --trace-warnings extract-pondered-rankings.js
      
      - name: Validate generated files
        run: |
          echo "===== DATA DIRECTORY CONTENT ====="
          ls -la data/*_latest.json 2>/dev/null || echo "⚠️ Aucun fichier _latest.json trouvé"
          
          # Vérifier que les fichiers latest ne sont pas vides ou trop petits
          for f in data/*_ponderated_latest.json; do
            if [ -f "$f" ]; then
              SIZE=$(stat -c%s "$f" 2>/dev/null || stat -f%z "$f" 2>/dev/null)
              if [ "$SIZE" -lt 1000 ]; then
                echo "⚠️ ALERTE: $f ne fait que ${SIZE} octets (extraction probablement ratée)"
              else
                echo "✅ $f — ${SIZE} octets"
              fi
            fi
          done
      
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # N'ajouter QUE les fichiers *_latest.json (pas les datés)
          git add data/*_ponderated_latest.json 2>/dev/null || echo "No latest files to add"
          
          git status
          git diff --cached --quiet || git commit -m "Mise à jour des classements pondérés ($(date +%Y-%m-%d))"
          git push || echo "Push failed, possibly no changes"
