<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Hippique</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... Tout le CSS reste inchangé ... */
    </style>
</head>
<body>
    <!-- ... Tout le HTML reste inchangé jusqu'à la partie JavaScript ... -->

    <!-- Module de chargement des courses -->
    <script>
        // Module de chargement des courses
        const coursesLoader = {
            // ... Le code reste inchangé ...
        };

        document.addEventListener('DOMContentLoaded', function() {
            // ... Le code reste inchangé jusqu'à la génération du HTML des participants ...
            
            // Fonction pour afficher/masquer les détails d'une course sous la carte
            async function toggleCourseDetails(hippodrome, courseName, detailId, courseCard) {
                // ... Le code reste inchangé jusqu'à la génération du HTML des participants ...
                
                    try {
                        // MODIFICATION: Utiliser rankingLoader au lieu de scorePredictor
                        const scoresPredictifs = await rankingLoader.calculerScoresCourse(course);
                        
                        if (scoresPredictifs.length === 0) {
                            participantsContainer.innerHTML = `
                                <tr>
                                    <td colspan="8" style="text-align: center;">
                                        <i class="fas fa-exclamation-circle" style="color: var(--gold);"></i> 
                                        Impossible de calculer les scores prédictifs pour cette course.
                                    </td>
                                </tr>
                            `;
                            return;
                        }
                        
                        let participantsHTML = '';
                        
                        // Trier par numéro de participant (ordre initial)
                        const participantsTries = [...scoresPredictifs].sort((a, b) => {
                            const numA = parseInt(a.participant.numero || 0);
                            const numB = parseInt(b.participant.numero || 0);
                            return numA - numB;
                        });
                        
                        participantsTries.forEach((resultat, index) => {
                            const participant = resultat.participant;
                            const scorePredictif = resultat.scorePredictif;
                            
                            // Réduire la taille de certaines colonnes si le texte est trop long
                            const propietaire = getPropertyValue(participant, [
                                "proprietaire", "propriétaire", "proprio", "owner", "owner_name"
                            ]) || "N/A";
                            
                            const eleveurs = getPropertyValue(participant, [
                                "eleveurs", "éleveurs", "eleveur", "éleveur", "breeder", "breeder_name"
                            ]) || "N/A";
                            
                            // Calculer une couleur de fond pour la barre de score entre rouge et vert en fonction du score
                            const score = parseFloat(scorePredictif.score);
                            const normalizedScore = Math.min(Math.max(0, score), 100) / 100; // 0 à 1
                            
                            // Indice de confiance avec classe de style
                            const confidence = scorePredictif.indiceConfiance ? parseFloat(scorePredictif.indiceConfiance) : 0;
                            let confidenceClass = 'confidence-low';
                            if (confidence >= 0.8) {
                                confidenceClass = 'confidence-high';
                            } else if (confidence >= 0.5) {
                                confidenceClass = 'confidence-medium';
                            }
                            
                            // Calculer le score NC basé sur l'indice de confiance pour l'affichage
                            const ncScore = (15 * (1 + confidence)).toFixed(1);
                            
                            participantsHTML += `
                                <tr data-score="${scorePredictif.score}" data-numero="${participant.numero || 0}">
                                    <td style="text-align: center;">
                                        <div class="horse-number">${participant.numero || '-'}</div>
                                    </td>
                                    <td>${participant.cheval || 'N/A'}</td>
                                    <td>${participant.jockey || 'N/A'}</td>
                                    <td>${participant.entraineur || 'N/A'}</td>
                                    <td>${propietaire.length > 20 ? propietaire.slice(0, 20) + '...' : propietaire}</td>
                                    <td>${eleveurs.length > 20 ? eleveurs.slice(0, 20) + '...' : eleveurs}</td>
                                    <td>${participant.poids || 'N/A'}</td>
                                    <td class="prediction-cell">
                                        <div class="prediction-bar-container">
                                            <div class="prediction-bar" style="width: ${normalizedScore * 100}%;"></div>
                                            <div class="prediction-value">
                                                ${participant.status === 'NC' ? 
                                                    `${ncScore} pts` : 
                                                    scorePredictif.score}
                                            </div>
                                        </div>
                                        <div class="score-details">
                                            <small>
                                                Détails <i class="fas fa-info-circle"></i>
                                                ${scorePredictif.indiceConfiance ? 
                                                    `<span class="confidence-indicator ${confidenceClass}">${parseFloat(scorePredictif.indiceConfiance) * 100}% fiable</span>` : 
                                                    ''}
                                            </small>
                                            <div class="tooltip-content">
                                                <p>Cheval: Rang #${scorePredictif.details.cheval.rang} (${participant.status === 'NC' && scorePredictif.details.cheval.rang === 'NC' ? ncScore : scorePredictif.details.cheval.score} pts)</p>
                                                <p>Jockey: Rang #${scorePredictif.details.jockey.rang} (${scorePredictif.details.jockey.score} pts)</p>
                                                <p>Entraîneur: Rang #${scorePredictif.details.entraineur.rang} (${scorePredictif.details.entraineur.score} pts)</p>
                                                <p>Éleveur: Rang #${scorePredictif.details.eleveur.rang} (${scorePredictif.details.eleveur.score} pts)</p>
                                                <p>Propriétaire: Rang #${scorePredictif.details.proprietaire.rang} (${scorePredictif.details.proprietaire.score} pts)</p>
                                                ${scorePredictif.indiceConfiance ? 
                                                  `<p><strong>Fiabilité: ${parseFloat(scorePredictif.indiceConfiance) * 100}%</strong> (${getConfidenceDescription(parseFloat(scorePredictif.indiceConfiance))})</p>` : 
                                                  ''}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        participantsContainer.innerHTML = participantsHTML;
                        
                        // ... Le reste du code reste inchangé ...
            
            // ... Le reste du code reste inchangé ...
        });
    </script>
    
    <!-- Ajout du nouveau module ranking-loader.js -->
    <script src="js/ranking-loader.js?v=1"></script>
</body>
</html>